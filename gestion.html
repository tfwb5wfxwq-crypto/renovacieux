<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Gestion - Renovacieux</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 60 70'%3E%3Crect x='4' y='54' width='52' height='8' rx='1' fill='%23C5C0B8'/%3E%3Cpath d='M8 58 L8 22 Q8 8 30 8 Q52 8 52 22 L52 58 Z' fill='%23D8D4CD' stroke='%23C5C0B8' stroke-width='1'/%3E%3Ctext x='30' y='44' text-anchor='middle' font-family='Georgia,serif' font-size='28' fill='%233D6B7C'%3ER%3C/text%3E%3C/svg%3E">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --bg: #F0F4F7;
      --bg-gradient: linear-gradient(135deg, #E8EEF2 0%, #F5F8FA 50%, #EDF2F5 100%);
      --white: #FFFFFF;
      --primary: #3D6B7C;
      --primary-light: #5A8A9C;
      --primary-dark: #2A4F5C;
      --accent: #C9A55C;
      --green: #34A853;
      --green-light: #E6F4EA;
      --orange: #EA8600;
      --orange-light: #FEF3E0;
      --red: #DC3545;
      --red-light: #FCE8E8;
      --text: #1A2632;
      --text-light: #5A6A7A;
      --text-muted: #8A9AAA;
      --border: #E0E7ED;
      --shadow: 0 4px 20px rgba(0,0,0,0.06);
      --shadow-lg: 0 8px 40px rgba(0,0,0,0.1);
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg-gradient);
      color: var(--text);
      min-height: 100vh;
      font-size: 16px;
      -webkit-tap-highlight-color: transparent;
      line-height: 1.5;
    }

    /* ===== LOGIN ===== */
    .login-screen {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 40px 20px;
      background: var(--bg-gradient);
    }

    .login-logo {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 28px;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 40px;
    }

    .login-logo svg {
      width: 48px;
      height: 48px;
    }

    .login-box {
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255,255,255,0.6);
      border-radius: 24px;
      padding: 48px 40px;
      width: 100%;
      max-width: 420px;
      box-shadow: var(--shadow-lg);
    }

    .login-box h2 {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 8px;
      text-align: center;
      color: var(--text);
    }

    .login-box p {
      font-size: 15px;
      color: var(--text-light);
      text-align: center;
      margin-bottom: 32px;
    }

    .login-box input {
      width: 100%;
      padding: 18px 20px;
      font-size: 18px;
      border: 2px solid var(--border);
      border-radius: 14px;
      margin-bottom: 16px;
      text-align: center;
      letter-spacing: 3px;
      font-family: inherit;
      background: var(--white);
      transition: all 0.2s;
    }

    .login-box input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(61, 107, 124, 0.1);
    }

    .login-box button {
      width: 100%;
      padding: 18px;
      font-size: 17px;
      font-weight: 600;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      border: none;
      border-radius: 14px;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 4px 15px rgba(61, 107, 124, 0.3);
    }

    .login-box button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(61, 107, 124, 0.4);
    }

    .login-box button:active {
      transform: scale(0.98);
    }

    .login-error {
      color: var(--red);
      text-align: center;
      margin-top: 16px;
      font-size: 14px;
      font-weight: 500;
      display: none;
    }

    /* ===== APP ===== */
    .app {
      display: none;
      min-height: 100vh;
    }

    .app.active {
      display: block;
    }

    /* Header */
    .header {
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      padding: 16px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-logo {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 20px;
      font-weight: 700;
      color: var(--primary);
    }

    .header-logo svg {
      width: 36px;
      height: 36px;
    }

    .header-logout {
      padding: 10px 18px;
      font-size: 14px;
      font-weight: 500;
      background: var(--white);
      border: 1px solid var(--border);
      border-radius: 10px;
      cursor: pointer;
      color: var(--text-light);
      transition: all 0.2s;
    }

    .header-logout:hover {
      background: var(--bg);
      border-color: var(--primary);
      color: var(--primary);
    }

    /* Tabs */
    .tabs {
      display: flex;
      background: var(--white);
      border-bottom: 1px solid var(--border);
      padding: 0 16px;
    }

    .tab {
      flex: 1;
      padding: 16px 12px;
      font-size: 14px;
      font-weight: 600;
      text-align: center;
      background: none;
      border: none;
      border-bottom: 3px solid transparent;
      cursor: pointer;
      color: var(--text-light);
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .tab:hover {
      color: var(--primary);
    }

    .tab.active {
      color: var(--primary);
      border-bottom-color: var(--primary);
    }

    .tab-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 22px;
      height: 22px;
      background: var(--red);
      color: white;
      font-size: 12px;
      font-weight: 700;
      padding: 0 6px;
      border-radius: 11px;
    }

    /* Content */
    .content {
      padding: 24px;
      max-width: 700px;
      margin: 0 auto;
    }

    .page {
      display: none;
    }

    .page.active {
      display: block;
    }

    /* ===== CLIENT CARDS ===== */
    .client-card {
      background: var(--white);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 12px;
      box-shadow: var(--shadow);
      cursor: pointer;
      transition: all 0.2s;
      border-left: 4px solid var(--border);
      position: relative;
      overflow: hidden;
    }

    .client-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, transparent 0%, rgba(61, 107, 124, 0.02) 100%);
      opacity: 0;
      transition: opacity 0.2s;
    }

    .client-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .client-card:hover::before {
      opacity: 1;
    }

    .client-card:active {
      transform: scale(0.99);
    }

    .client-card.new {
      border-left-color: var(--red);
      background: linear-gradient(135deg, var(--white) 0%, var(--red-light) 100%);
    }

    .client-card.pending {
      border-left-color: var(--orange);
      background: linear-gradient(135deg, var(--white) 0%, var(--orange-light) 100%);
    }

    .client-card.active-client {
      border-left-color: var(--green);
      background: linear-gradient(135deg, var(--white) 0%, var(--green-light) 100%);
    }

    .client-card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
    }

    .client-name {
      font-size: 18px;
      font-weight: 600;
      color: var(--text);
    }

    .client-status {
      font-size: 12px;
      padding: 5px 12px;
      border-radius: 20px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .client-status.new {
      background: var(--red);
      color: white;
    }

    .client-status.pending {
      background: var(--orange);
      color: white;
    }

    .client-status.active-client {
      background: var(--green);
      color: white;
    }

    .client-info {
      font-size: 14px;
      color: var(--text-light);
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .client-info span {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* Empty state */
    .empty-state {
      text-align: center;
      padding: 80px 20px;
      color: var(--text-muted);
    }

    .empty-state-icon {
      font-size: 64px;
      margin-bottom: 20px;
      opacity: 0.5;
    }

    .empty-state p {
      font-size: 16px;
    }

    /* ===== DETAIL PAGE ===== */
    .detail-back {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 15px;
      font-weight: 500;
      color: var(--primary);
      background: none;
      border: none;
      padding: 12px 0;
      margin-bottom: 16px;
      cursor: pointer;
    }

    .detail-back:hover {
      text-decoration: underline;
    }

    .detail-card {
      background: var(--white);
      border-radius: 20px;
      padding: 28px;
      margin-bottom: 16px;
      box-shadow: var(--shadow);
    }

    .detail-card h3 {
      font-size: 13px;
      font-weight: 700;
      color: var(--text-muted);
      margin-bottom: 20px;
      text-transform: uppercase;
      letter-spacing: 1px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group:last-child {
      margin-bottom: 0;
    }

    .form-group label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      color: var(--text-light);
      margin-bottom: 8px;
    }

    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 14px 16px;
      font-size: 16px;
      border: 2px solid var(--border);
      border-radius: 12px;
      background: var(--white);
      font-family: inherit;
      transition: all 0.2s;
      color: var(--text);
    }

    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(61, 107, 124, 0.08);
    }

    .form-group textarea {
      min-height: 100px;
      resize: vertical;
      line-height: 1.6;
    }

    .form-group select {
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%235A6A7A' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 14px center;
      padding-right: 44px;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    @media (max-width: 500px) {
      .form-row {
        grid-template-columns: 1fr;
      }
    }

    .form-group.readonly input,
    .form-group.readonly textarea {
      background: var(--bg);
      color: var(--text-light);
      border-color: transparent;
    }

    /* Toggle buttons */
    .toggle-buttons {
      display: flex;
      gap: 10px;
    }

    .toggle-btn {
      flex: 1;
      padding: 14px 16px;
      font-size: 15px;
      font-weight: 500;
      border: 2px solid var(--border);
      border-radius: 12px;
      background: var(--white);
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .toggle-btn:hover {
      border-color: var(--primary);
    }

    .toggle-btn.selected {
      border-color: var(--primary);
      background: rgba(61, 107, 124, 0.08);
      color: var(--primary);
    }

    /* Buttons */
    .btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      width: 100%;
      padding: 16px 24px;
      font-size: 16px;
      font-weight: 600;
      border: none;
      border-radius: 14px;
      cursor: pointer;
      margin-bottom: 10px;
      transition: all 0.2s;
      font-family: inherit;
    }

    .btn:active {
      transform: scale(0.98);
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      box-shadow: 0 4px 15px rgba(61, 107, 124, 0.3);
    }

    .btn-primary:hover {
      box-shadow: 0 6px 20px rgba(61, 107, 124, 0.4);
      transform: translateY(-1px);
    }

    .btn-success {
      background: linear-gradient(135deg, var(--green) 0%, #2E8B47 100%);
      color: white;
      box-shadow: 0 4px 15px rgba(52, 168, 83, 0.3);
    }

    .btn-success:hover {
      box-shadow: 0 6px 20px rgba(52, 168, 83, 0.4);
    }

    .btn-outline {
      background: var(--white);
      color: var(--text);
      border: 2px solid var(--border);
    }

    .btn-outline:hover {
      border-color: var(--primary);
      background: rgba(61, 107, 124, 0.03);
    }

    .btn-danger {
      background: var(--white);
      color: var(--red);
      border: 2px solid var(--red);
    }

    .btn-danger:hover {
      background: var(--red-light);
    }

    .btn-call {
      background: linear-gradient(135deg, var(--accent) 0%, #B8954C 100%);
      color: white;
      box-shadow: 0 4px 15px rgba(201, 165, 92, 0.3);
    }

    /* Divider */
    .divider {
      height: 1px;
      background: var(--border);
      margin: 24px 0;
    }

    /* Screen visibility */
    .screen {
      display: none;
    }

    .screen.active {
      display: block;
    }

    /* Logo SVG */
    .logo-svg {
      width: 40px;
      height: 40px;
    }
  </style>
</head>
<body>

  <!-- LOGIN SCREEN -->
  <div class="screen login-screen active" id="loginScreen">
    <div class="login-logo">
      <svg viewBox="0 0 60 70">
        <rect x="4" y="54" width="52" height="8" rx="1" fill="#C5C0B8"/>
        <path d="M8 58 L8 22 Q8 8 30 8 Q52 8 52 22 L52 58 Z" fill="#D8D4CD" stroke="#C5C0B8" stroke-width="1"/>
        <text x="30" y="44" text-anchor="middle" font-family="Georgia,serif" font-size="28" fill="#3D6B7C">R</text>
      </svg>
      Renovacieux
    </div>
    <div class="login-box">
      <h2>Espace gestion</h2>
      <p>Connecte-toi pour g√©rer tes clients</p>
      <input type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="off">
      <button onclick="tryLogin()">Se connecter</button>
      <p class="login-error" id="loginError">‚ùå Mot de passe incorrect</p>
    </div>
  </div>

  <!-- MAIN APP -->
  <div class="screen app" id="appScreen">

    <!-- Header -->
    <header class="header">
      <div class="header-logo">
        <svg viewBox="0 0 60 70">
          <rect x="4" y="54" width="52" height="8" rx="1" fill="#C5C0B8"/>
          <path d="M8 58 L8 22 Q8 8 30 8 Q52 8 52 22 L52 58 Z" fill="#D8D4CD" stroke="#C5C0B8" stroke-width="1"/>
          <text x="30" y="44" text-anchor="middle" font-family="Georgia,serif" font-size="28" fill="#3D6B7C">R</text>
        </svg>
        Gestion
      </div>
      <button class="header-logout" onclick="logout()">D√©connexion</button>
    </header>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab active" data-tab="nouveaux" onclick="switchTab('nouveaux')">
        üÜï Nouveaux
        <span class="tab-badge" id="newCount">0</span>
      </button>
      <button class="tab" data-tab="clients" onclick="switchTab('clients')">
        üë• Tous les clients
      </button>
      <button class="tab" data-tab="calendrier" onclick="switchTab('calendrier')">
        üìÖ Calendrier
      </button>
    </div>

    <!-- Content -->
    <div class="content">

      <!-- Page: Nouveaux -->
      <div class="page active" id="page-nouveaux">
        <div id="newClientsList"></div>
        <div class="empty-state" id="emptyNew" style="display:none;">
          <div class="empty-state-icon">‚úÖ</div>
          <p>Aucun nouveau contact √† traiter</p>
        </div>
      </div>

      <!-- Page: Clients -->
      <div class="page" id="page-clients">
        <div id="clientsList"></div>
        <div class="empty-state" id="emptyClients" style="display:none;">
          <div class="empty-state-icon">üë•</div>
          <p>Aucun client pour l'instant</p>
        </div>
      </div>

      <!-- Page: Calendrier -->
      <div class="page" id="page-calendrier">
        <div class="empty-state">
          <div class="empty-state-icon">üìÖ</div>
          <p>Synchronisation Google Calendar</p>
          <p style="margin-top:8px; font-size:14px; opacity:0.7;">(Bient√¥t disponible)</p>
        </div>
      </div>

      <!-- Page: Detail client -->
      <div class="page" id="page-detail">
        <button class="detail-back" onclick="goBack()">
          ‚Üê Retour √† la liste
        </button>

        <!-- Infos du formulaire -->
        <div class="detail-card">
          <h3>üìã Infos re√ßues du site</h3>
          <div class="form-row">
            <div class="form-group readonly">
              <label>Nom</label>
              <input type="text" id="detail-nom" readonly>
            </div>
            <div class="form-group readonly">
              <label>Pr√©nom</label>
              <input type="text" id="detail-prenom" readonly>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group readonly">
              <label>T√©l√©phone</label>
              <input type="text" id="detail-tel" readonly>
            </div>
            <div class="form-group readonly">
              <label>Email</label>
              <input type="text" id="detail-email" readonly>
            </div>
          </div>
          <div class="form-group readonly">
            <label>Cimeti√®re</label>
            <input type="text" id="detail-cimetiere" readonly>
          </div>
          <div class="form-group readonly">
            <label>Formule demand√©e</label>
            <input type="text" id="detail-formule-init" readonly>
          </div>
          <div class="form-group readonly">
            <label>Message</label>
            <textarea id="detail-message" readonly></textarea>
          </div>
        </div>

        <!-- √Ä compl√©ter -->
        <div class="detail-card">
          <h3>‚úèÔ∏è √Ä compl√©ter (appel)</h3>
          <div class="form-group">
            <label>O√π se trouve la tombe ?</label>
            <input type="text" id="detail-position" placeholder="Ex: All√©e 4, Rang 12, num√©ro 8">
          </div>
          <div class="form-group">
            <label>Facile √† trouver ?</label>
            <div class="toggle-buttons">
              <button class="toggle-btn" data-value="oui" onclick="selectOption(this, 'facile')">‚úÖ Oui</button>
              <button class="toggle-btn" data-value="non" onclick="selectOption(this, 'facile')">‚ùå Non, difficile</button>
            </div>
          </div>
          <div class="form-group">
            <label>Notes importantes</label>
            <textarea id="detail-notes" placeholder="Ce qu'il faut retenir de l'appel..."></textarea>
          </div>

          <div class="divider"></div>

          <div class="form-group">
            <label>Formule choisie</label>
            <select id="detail-formule">
              <option value="">Pas encore d√©cid√©</option>
              <option value="ponctuel">üîπ Ponctuel ‚Äî 89‚Ç¨</option>
              <option value="serenite">üî∑ S√©r√©nit√© ‚Äî 180‚Ç¨/an (2 passages)</option>
              <option value="prestige">‚≠ê Prestige ‚Äî 420‚Ç¨/an (4 passages)</option>
            </select>
          </div>
          <div class="form-group">
            <label>Statut du client</label>
            <select id="detail-statut">
              <option value="nouveau">üÜï Nouveau</option>
              <option value="a_rappeler">üìû √Ä rappeler</option>
              <option value="en_discussion">üí¨ En discussion</option>
              <option value="devis_envoye">üìÑ Devis envoy√©</option>
              <option value="attente_paiement">üí≥ Attente paiement</option>
              <option value="actif">‚úÖ Client actif</option>
              <option value="perdu">‚ùå Perdu</option>
            </select>
          </div>
        </div>

        <button class="btn btn-primary" onclick="saveClient()">
          üíæ Enregistrer les modifications
        </button>

        <!-- Actions -->
        <div class="detail-card">
          <h3>üì§ Actions rapides</h3>
          <button class="btn btn-call" onclick="callClient()">
            üìû Appeler ce client
          </button>
          <button class="btn btn-outline" onclick="generateDevis()">
            üìÑ G√©n√©rer un devis PDF
          </button>
          <button class="btn btn-success" onclick="sendPaymentLink()">
            üí≥ Envoyer un lien de paiement
          </button>
        </div>

        <div class="divider"></div>

        <button class="btn btn-danger" onclick="deleteClient()">
          üóëÔ∏è Supprimer ce contact
        </button>

      </div>

    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // ===== SUPABASE CONFIG =====
    const SUPABASE_URL = 'https://ujfyvlkmsabinrfylzdr.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVqZnl2bGttc2FiaW5yZnlsemRyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk5NDY0NzcsImV4cCI6MjA4NTUyMjQ3N30.SeDhwjsdOisDO-OTLTbtsvjbXLAc8QT-T8cvfs0tZSQ';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const PASSWORD = 'kikinou75';

    let clients = [];
    let currentClientId = null;
    let currentTab = 'nouveaux';

    // ===== SUPABASE FUNCTIONS =====
    async function loadClients() {
      const { data, error } = await supabase
        .from('clients')
        .select('*')
        .order('created_at', { ascending: false });

      if (error) {
        console.error('Erreur chargement:', error);
        return;
      }
      clients = data || [];
      renderLists();
    }

    async function updateClient(id, updates) {
      const { error } = await supabase
        .from('clients')
        .update({ ...updates, updated_at: new Date().toISOString() })
        .eq('id', id);

      if (error) {
        console.error('Erreur update:', error);
        alert('Erreur lors de la sauvegarde');
        return false;
      }
      return true;
    }

    async function removeClient(id) {
      const { error } = await supabase
        .from('clients')
        .delete()
        .eq('id', id);

      if (error) {
        console.error('Erreur delete:', error);
        alert('Erreur lors de la suppression');
        return false;
      }
      return true;
    }

    // ===== LOGIN =====
    function tryLogin() {
      const pwd = document.getElementById('loginPassword').value;
      if (pwd === PASSWORD) {
        document.getElementById('loginScreen').classList.remove('active');
        document.getElementById('appScreen').classList.add('active');
        localStorage.setItem('renovacieux_logged', 'true');
        loadClients();
      } else {
        document.getElementById('loginError').style.display = 'block';
        document.getElementById('loginPassword').style.borderColor = '#DC3545';
      }
    }

    function logout() {
      localStorage.removeItem('renovacieux_logged');
      location.reload();
    }

    if (localStorage.getItem('renovacieux_logged') === 'true') {
      document.getElementById('loginScreen').classList.remove('active');
      document.getElementById('appScreen').classList.add('active');
      loadClients();
    }

    document.getElementById('loginPassword').addEventListener('keyup', (e) => {
      if (e.key === 'Enter') tryLogin();
      document.getElementById('loginError').style.display = 'none';
      document.getElementById('loginPassword').style.borderColor = '';
    });

    // ===== TABS =====
    function switchTab(tab) {
      currentTab = tab;
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.getElementById('page-' + tab).classList.add('active');
    }

    function goBack() {
      switchTab(currentTab);
    }

    // ===== RENDER =====
    function renderLists() {
      const newClients = clients.filter(c => c.statut === 'nouveau');
      const otherClients = clients.filter(c => c.statut !== 'nouveau');

      document.getElementById('newCount').textContent = newClients.length;
      document.getElementById('newCount').style.display = newClients.length > 0 ? 'inline-flex' : 'none';

      const newList = document.getElementById('newClientsList');
      if (newClients.length === 0) {
        newList.innerHTML = '';
        document.getElementById('emptyNew').style.display = 'block';
      } else {
        document.getElementById('emptyNew').style.display = 'none';
        newList.innerHTML = newClients.map(c => renderClientCard(c)).join('');
      }

      const clientList = document.getElementById('clientsList');
      if (otherClients.length === 0) {
        clientList.innerHTML = '';
        document.getElementById('emptyClients').style.display = 'block';
      } else {
        document.getElementById('emptyClients').style.display = 'none';
        clientList.innerHTML = otherClients.map(c => renderClientCard(c)).join('');
      }
    }

    function renderClientCard(client) {
      const statusLabels = {
        nouveau: ['new', 'Nouveau'],
        a_rappeler: ['pending', '√Ä rappeler'],
        en_discussion: ['pending', 'En discussion'],
        devis_envoye: ['pending', 'Devis envoy√©'],
        attente_paiement: ['pending', 'Attente paiement'],
        actif: ['active-client', 'Client actif'],
        perdu: ['', 'Perdu']
      };

      const [statusClass, statusLabel] = statusLabels[client.statut] || ['', client.statut];

      return `
        <div class="client-card ${statusClass}" onclick="openClient(${client.id})">
          <div class="client-card-header">
            <div class="client-name">${client.prenom} ${client.nom}</div>
            <div class="client-status ${statusClass}">${statusLabel}</div>
          </div>
          <div class="client-info">
            <span>üìç ${client.cimetiere || 'Cimeti√®re non renseign√©'}</span>
            <span>üìû ${client.tel || 'Pas de t√©l√©phone'}</span>
          </div>
        </div>
      `;
    }

    // ===== CLIENT DETAIL =====
    function openClient(id) {
      currentClientId = id;
      const client = clients.find(c => c.id === id);
      if (!client) return;

      document.getElementById('detail-nom').value = client.nom || '';
      document.getElementById('detail-prenom').value = client.prenom || '';
      document.getElementById('detail-tel').value = client.tel || '';
      document.getElementById('detail-email').value = client.email || '';
      document.getElementById('detail-cimetiere').value = client.cimetiere || '';
      document.getElementById('detail-formule-init').value = client.formule_demandee || '';
      document.getElementById('detail-message').value = client.message || '';
      document.getElementById('detail-position').value = client.position_tombe || '';
      document.getElementById('detail-notes').value = client.notes || '';
      document.getElementById('detail-formule').value = client.formule_choisie || '';
      document.getElementById('detail-statut').value = client.statut || 'nouveau';

      document.querySelectorAll('[onclick*="facile"]').forEach(el => {
        el.classList.toggle('selected', el.dataset.value === client.facile_trouver);
      });

      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.getElementById('page-detail').classList.add('active');
    }

    function selectOption(el, group) {
      el.parentElement.querySelectorAll('.toggle-btn').forEach(o => o.classList.remove('selected'));
      el.classList.add('selected');
    }

    async function saveClient() {
      const facileEl = document.querySelector('[onclick*="facile"].selected');

      const updates = {
        position_tombe: document.getElementById('detail-position').value,
        notes: document.getElementById('detail-notes').value,
        formule_choisie: document.getElementById('detail-formule').value,
        statut: document.getElementById('detail-statut').value,
        facile_trouver: facileEl ? facileEl.dataset.value : ''
      };

      const btn = event.target;
      const originalText = btn.innerHTML;
      btn.innerHTML = '‚è≥ Sauvegarde...';
      btn.disabled = true;

      const success = await updateClient(currentClientId, updates);

      if (success) {
        btn.innerHTML = '‚úÖ Enregistr√© !';
        btn.style.background = 'var(--green)';
        await loadClients();
      } else {
        btn.innerHTML = '‚ùå Erreur';
        btn.style.background = 'var(--red)';
      }

      setTimeout(() => {
        btn.innerHTML = originalText;
        btn.style.background = '';
        btn.disabled = false;
      }, 1500);
    }

    async function deleteClient() {
      if (!confirm('Supprimer d√©finitivement ce contact ?')) return;

      const success = await removeClient(currentClientId);
      if (success) {
        await loadClients();
        goBack();
      }
    }

    // ===== ACTIONS =====
    function generateDevis() {
      const client = clients.find(c => c.id === currentClientId);
      alert(`üìÑ G√©n√©ration du devis pour ${client.prenom} ${client.nom}\n\n(Fonctionnalit√© bient√¥t disponible)`);
    }

    function sendPaymentLink() {
      const client = clients.find(c => c.id === currentClientId);
      alert(`üí≥ Envoi du lien de paiement √† ${client.email}\n\n(Fonctionnalit√© bient√¥t disponible)`);
    }

    function callClient() {
      const client = clients.find(c => c.id === currentClientId);
      if (client && client.tel) {
        window.location.href = 'tel:' + client.tel.replace(/\s/g, '');
      }
    }
  </script>

</body>
</html>
